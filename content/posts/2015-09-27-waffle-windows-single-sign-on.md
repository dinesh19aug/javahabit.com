---
title: 'Waffle : Windows Single Sign On'
author: Dinesh
type: post
date: 2015-09-27T22:38:03+00:00
url: /2015/09/27/waffle-windows-single-sign-on/
snap_MYURL:
  -
  -
snapEdIT:
  - 1
  - 1
snapDL:
  - 's:285:"a:1:{i:0 a:10:{s:4:"doDL" s:1:"1" s:12:"rpstPostIncl" s:1:"0" s:11:"SNAPformatT" s:7:"%TITLE%" s:10:"SNAPformat" s:9:"%EXCERPT%" s:11:"isPrePosted" s:1:"1" s:2:"do" s:1:"1" s:10:"msgTFormat" s:7:"%TITLE%" s:9:"msgFormat" s:9:"%EXCERPT%" s:9:"isAutoURL" s:1:"A" s:8:"urlToUse" s:0:"" }}" '
  - 's:285:"a:1:{i:0 a:10:{s:4:"doDL" s:1:"1" s:12:"rpstPostIncl" s:1:"0" s:11:"SNAPformatT" s:7:"%TITLE%" s:10:"SNAPformat" s:9:"%EXCERPT%" s:11:"isPrePosted" s:1:"1" s:2:"do" s:1:"1" s:10:"msgTFormat" s:7:"%TITLE%" s:9:"msgFormat" s:9:"%EXCERPT%" s:9:"isAutoURL" s:1:"A" s:8:"urlToUse" s:0:"" }}" '
snapFB:
  - 's:332:"a:1:{i:0 a:11:{s:4:"doFB" s:1:"1" s:12:"rpstPostIncl" s:7:"nxsi0fb" s:8:"postType" s:1:"I" s:10:"AttachPost" s:1:"2" s:10:"SNAPformat" s:51:"New post (%TITLE%) has been published on %SITENAME%" s:9:"isAutoImg" s:1:"A" s:8:"imgToUse" s:0:"" s:9:"isAutoURL" s:1:"A" s:8:"urlToUse" s:0:"" s:11:"isPrePosted" s:1:"1" s:2:"do" s:1:"1" }}" '
  - 's:332:"a:1:{i:0 a:11:{s:4:"doFB" s:1:"1" s:12:"rpstPostIncl" s:7:"nxsi0fb" s:8:"postType" s:1:"I" s:10:"AttachPost" s:1:"2" s:10:"SNAPformat" s:51:"New post (%TITLE%) has been published on %SITENAME%" s:9:"isAutoImg" s:1:"A" s:8:"imgToUse" s:0:"" s:9:"isAutoURL" s:1:"A" s:8:"urlToUse" s:0:"" s:11:"isPrePosted" s:1:"1" s:2:"do" s:1:"1" }}" '
snapLI:
  - 's:387:"a:1:{i:0 a:12:{s:4:"doLI" s:1:"1" s:12:"rpstPostIncl" s:7:"nxsi0li" s:8:"postType" s:1:"A" s:10:"SNAPformat" s:41:"New post has been published on %SITENAME%" s:11:"SNAPformatT" s:18:"New Post - %TITLE%" s:9:"isAutoImg" s:1:"A" s:8:"imgToUse" s:0:"" s:9:"isAutoURL" s:1:"A" s:8:"urlToUse" s:0:"" s:11:"isPrePosted" s:1:"1" s:12:"liMsgFormatT" s:18:"New Post - %TITLE%" s:2:"do" s:1:"1" }}" '
  - 's:387:"a:1:{i:0 a:12:{s:4:"doLI" s:1:"1" s:12:"rpstPostIncl" s:7:"nxsi0li" s:8:"postType" s:1:"A" s:10:"SNAPformat" s:41:"New post has been published on %SITENAME%" s:11:"SNAPformatT" s:18:"New Post - %TITLE%" s:9:"isAutoImg" s:1:"A" s:8:"imgToUse" s:0:"" s:9:"isAutoURL" s:1:"A" s:8:"urlToUse" s:0:"" s:11:"isPrePosted" s:1:"1" s:12:"liMsgFormatT" s:18:"New Post - %TITLE%" s:2:"do" s:1:"1" }}" '
snap_isAutoPosted:
  - 1
  - 1
snapIP:
  - 's:269:"a:1:{i:0 a:9:{s:4:"doIP" s:1:"1" s:12:"rpstPostIncl" s:7:"nxsi0ip" s:11:"SNAPformatT" s:7:"%TITLE%" s:10:"SNAPformat" s:9:"%EXCERPT%" s:11:"isPrePosted" s:1:"1" s:8:"isPosted" s:1:"1" s:4:"pgID" s:9:"638572621" s:5:"pDate" s:19:"2015-09-27 22:38:17" s:2:"do" s:1:"1" }}" '
  - 's:269:"a:1:{i:0 a:9:{s:4:"doIP" s:1:"1" s:12:"rpstPostIncl" s:7:"nxsi0ip" s:11:"SNAPformatT" s:7:"%TITLE%" s:10:"SNAPformat" s:9:"%EXCERPT%" s:11:"isPrePosted" s:1:"1" s:8:"isPosted" s:1:"1" s:4:"pgID" s:9:"638572621" s:5:"pDate" s:19:"2015-09-27 22:38:17" s:2:"do" s:1:"1" }}" '
snapDI:
  - 's:339:"a:1:{i:0 a:12:{s:4:"doDI" s:1:"1" s:11:"SNAPformatT" s:7:"%TITLE%" s:10:"SNAPformat" s:9:"%EXCERPT%" s:11:"isPrePosted" s:1:"1" s:8:"isPosted" s:1:"1" s:4:"pgID" s:2:"DI" s:5:"pDate" s:19:"2015-09-27 22:38:18" s:2:"do" s:1:"1" s:10:"msgTFormat" s:7:"%TITLE%" s:9:"msgFormat" s:9:"%EXCERPT%" s:9:"isAutoURL" s:1:"A" s:8:"urlToUse" s:0:"" }}" '
  - 's:339:"a:1:{i:0 a:12:{s:4:"doDI" s:1:"1" s:11:"SNAPformatT" s:7:"%TITLE%" s:10:"SNAPformat" s:9:"%EXCERPT%" s:11:"isPrePosted" s:1:"1" s:8:"isPosted" s:1:"1" s:4:"pgID" s:2:"DI" s:5:"pDate" s:19:"2015-09-27 22:38:18" s:2:"do" s:1:"1" s:10:"msgTFormat" s:7:"%TITLE%" s:9:"msgFormat" s:9:"%EXCERPT%" s:9:"isAutoURL" s:1:"A" s:8:"urlToUse" s:0:"" }}" '
snapTW:
  - 's:162:"a:1:{i:0 a:6:{s:4:"doTW" s:1:"1" s:10:"SNAPformat" s:15:"%TITLE% - %URL%" s:8:"attchImg" s:1:"1" s:9:"isAutoImg" s:1:"A" s:8:"imgToUse" s:0:"" s:2:"do" s:1:"1" }}" '
  - 's:162:"a:1:{i:0 a:6:{s:4:"doTW" s:1:"1" s:10:"SNAPformat" s:15:"%TITLE% - %URL%" s:8:"attchImg" s:1:"1" s:9:"isAutoImg" s:1:"A" s:8:"imgToUse" s:0:"" s:2:"do" s:1:"1" }}" '
dsq_thread_id:
  - 5292097424
  - 5292097424
categories:
  - Tech Notes

---
Last week, I was working on an application where I had to do LDAP authentication. My cmpany has been using a very old jar file that had the required code for authenticating and authorizing users. There were two problems for me.

1. I had to revisit the documentation on LDAP setting in Jboss 4 and figure how to do the set up. Making changes in login-config.xml etc.

2. My new application is using Spring-boot, which comes with built in tomcat libraries. I had to either find some documentation on Timcat with Spring boot 4 or build the app as war and deploy in Jboss 7 and not Jboss 4, which means going over documentation and tutorial.

### What is waffle?

While trying to figure out a lazy way of doing things, I ran into Waffle project. <a href="https://github.com/dblock/waffle" target="_blank">WAFFLE </a>is a native Windows Authentication Framework consisting of two C# and Java libraries that perform functions related to Windows authentication, supporting Negotiate, NTLM and Kerberos. Waffle also includes libraries that enable drop-in Windows Single Sign On for popular Java web servers, when running on Windows. While Waffle makes it ridiculously easy to do Windows Authentication in Java, on Windows, Waffle does not work on *nix. In Short, if a user logs into his company computer, he would be authenticating over LDAP to make sure that he is authorized to use the computer. Waffle gives you an opportunity to make use of the exixsting infrastrutuce and help you authenticate and authorzie the user.

### Set Up::

To use waffle in java, we just need to add the maven dependency:
```
<properties>
<waffle.version>1.5</waffle.version>
</properties>`

<dependency>

<groupId>com.github.dblock.waffle</groupId>

<artifactId>waffle-jna</artifactId>

<version>${waffle.version}</version>

</dependency>

<dependency>
 <groupId> net.java.dev.jna</<wbr />groupId>
 <artifactId> platform</<wbr />artifactId>
 <version>3.5.2</version>
 </dependency>  
```
Create a new instance of waffle.windows.auth.impl.WindowsAuthProviderImpl.

Here are a couple of scenario that you can do without any nasty setup in Java, Jboss, Tomcat etc.

#### Scenario 1: Logon a user and get his domain and local groups

This calls Win32-LogonUser, checks the user token and extracts all local domain information.
```
IWindowsAuthProvider prov = new WindowsAuthProviderImpl()
IWindowsIdentity identity = prov.logonUser("userName", "pwd")
System.out.println("User identity: " + identity.getFqn())
for(IWindowsAccount group : identity.getGroups()) {
System.out.println(" " + group.getFqn() + " (" + group.getSidString() + ")")
}
```

Output::
```

User identity: acnna\darora
acnna\\None (S-1-5-21-42300245183-42300245183-3597729351-513)
Everyone (S-1-1-0)
acnna\\HomeUsers (S-1-5-21-42300245183-42300245183-3597729351-2418)
BUILTIN\Administrators (S-1-5-32-544)
BUILTIN\Users (S-1-5-32-545)
NT AUTHORITY\NETWORK (S-1-5-2)
```

#### Scenario 2: Active directory: get the list of trusted domains

```
IWindowsAuthProvider prov = new WindowsAuthProviderImpl()
IWindowsDomain[] domains = prov.getDomains()
for(IWindowsDomain domain : domains) {
System.out.println(domain.getFqn() + ": " + domain.getTrustDirectionString())
}
```

Output::

#### Scenario 3:: Is computer active on a domain?

```

IWindowsAuthProvider prov = new WindowsAuthProviderImpl()
IWindowsComputer computer = prov.getCurrentComputer()
System.out.println(computer.getComputerName())
System.out.println(computer.getJoinStatus())
System.out.println(computer.getMemberOf())
```

For systems that run both with and without active directory you need to programmatically figure out whether a computer is joined to a domain or a workgroup. If itâ€™s joined to a domain or a workgroup you want to know what domain the computer is joined to.

#### Scenario 4: Negotiate Single Sign on

This lets both client and server side to negotatite the sign on protocol. The code below, gets the token which can be shared between client and server and be used to lookup its domains.

```

String securityPackage = "Negotiate"
// client credentials handle
IWindowsCredentialsHandle clientCredentials = WindowsCredentialsHandleImpl.getCurrent(securityPackage)
clientCredentials.initialize()
// initial client security context
WindowsSecurityContextImpl clientContext = new WindowsSecurityContextImpl()
clientContext.setPrincipalName(Advapi32Util.getUserName())
clientContext.setCredentialsHandle(clientCredentials.getHandle())
clientContext.setSecurityPackage(securityPackage)
clientContext.initialize()
// accept on the server
WindowsAuthProviderImpl provider = new WindowsAuthProviderImpl()
IWindowsSecurityContext serverContext = null
do
{
if (serverContext != null) {
// initialize on the client
SecBufferDesc continueToken = new SecBufferDesc(Sspi.SECBUFFER_TOKEN, serverContext.getToken())
clientContext.initialize(clientContext.getHandle(), continueToken)
}
// accept the token on the server
serverContext = provider.acceptSecurityToken(clientContext.getToken(), securityPackage)
} while (clientContext.getContinue() || serverContext.getContinue()) `

System.out.println(serverContext.getIdentity().getFqn())

for (IWindowsAccount group : serverContext.getIdentity().getGroups()) {

System.out.println(&#8221  &#8221  + group.getFqn())

}

serverContext.dispose()

clientContext.dispose()

clientCredentials.dispose()


```
~Ciao
